# 实验三：DNS安全性测量

- 2015011278 谭闻德：整理AS4538宣告的前缀列表、完成`edu.cn.`权威服务器的发现、统计单权威服务器的域名列表、探测被防火墙劫持的域名列表、撰写测试分析报告
- 2016010981 陈晟祺：完成AS4538解析服务器的发现、测试权威服务器的区域传输、测试权威服务器的动态更新、撰写测试分析报告

## 概述

总体而言，本次实验分为以下几个部分：

* 教育网DNS安全性测量
  * 通过`edu.cn.`域名列表发现权威服务器
  * 统计单权威服务器的域名列表
  * 测试权威服务器的区域传输
  * 测试权威服务器的动态更新
  * 通过AS4538宣告的前缀列表发现解析服务器
* 中国大陆DNS劫持分析与绕过
  * 探测被防火墙劫持的域名列表
  * 开发用于绕过劫持的小工具

## 已有数据

由于`edu.cn.`的区域文件不公开，《实验指导手册》提供了`edu.cn.`域名列表。

其他数据均可以从公开渠道获得。

## 实验内容

### 教育网DNS安全性测量

本节实验主要在清华大学基础云平台的虚拟机上进行，该服务器接入清华大学校园网，运行 Debian 9 操作系统。

本节发现的所有潜在安全风险以及获得的其他数据，均已如数上报 CERNOC 与 CERT 进行处理。

#### 权威服务器的发现与统计

本小节使用《实验指导手册》提供的 `edu.cn.` 域名列表（`edu_cn_ns/edu_domain.txt`，含 6338 个域名），以及如下命令：

```bash
dig @dns2.edu.cn NS -f edu_domain.txt
```

该命令批量地查询指定域名列表的 NS 记录和相应的胶水记录（glue record， 即和 NS 记录关联的 A 或者 AAAA 记录）。`dig` 输出的原始数据保存在 `edu_cn_ns/edu_domain_ns_dig.txt`，滤去注释和空行之后的有用数据保存在 `edu_cn_ns/edu_domain_ns.txt`。本节还对每个域名的权威域名服务器列表，包括域名及对应 IPv4 地址，进行了进一步统计，结果存储在 `edu_cn_ns/ns_report_authority.txt`。注意到，有 14 个域名没有 NS 记录，约占 0.22%。

特别地，本节还统计了只有单一 NS 记录的域名列表（`edu_cn_ns/ns_report_single_authority.txt`），发现这样的域名有 337 个，在有 NS 记录的 6324 个域名中约占 5.33%。这些域名缺乏必要的冗余。

然而，经过对所有域名的 NS 记录进行简单分析后，本节还发现绝大部分域名的不同 NS 记录指向的该域名的权威服务器的 IP 地址十分邻近，有理由认为这些服务器在地理位置上也是邻近的。这表明，绝大部分域名的权威服务器并没有做到地理上的隔离。

#### 测试权威服务器的区域传输

AXFR，又称为区域传送，是一种特殊的 DNS 请求类型，用于向权威服务器查询隶属于某个域的所有记录，一般用于主备权威服务器之间的同步。由于其能泄露一些敏感信息（如内部使用的域名等），同时整个区域体积较大，对服务器压力较大，一级域名的权威服务器一般不应该对外开放 AXFR 记录的查询。

我们利用上文得到的所有域名与其对应的权威服务器列表，使用 Python 撰写脚本批量地向所有被发现的权威服务器发送对其管辖的域名的 AXFR 查询。每个查询使用的参数类似为 `+time=1 +tries=1 @211.71.253.1 AXFR bjeea.edu.cn`，其中 `time` 和 `tries` 参数是为了避免服务器无响应导致的超时拖慢实验。

令我们惊讶的是，我们从 68 台服务器上得到了返回的结果，具体可见 `axfr_result` 目录。其中，不同的域名有 59 个。在只有一台服务器响应 AXFR 的 50 个域名中，绝大部分都是配置了多个 NS 记录的。我们可以合理推断，管理员或许是为了进行主从复制而打开了主域名服务器的区域传送功能，但是却没有正确配置访问权限控制。

另外，从这些 DNS zone 中我们还能得到不少有趣的观察。比如，许多域名只有大量指向一致的 A 和 AAAA 记录（典型的例子是 `hezeu.edu.cn`），很明显是一台服务器运行了多个服务。这种情况的最佳实践应当是使用 CNAME 解耦服务器与服务对应的记录，如：

```bind
alfa.s.tuna.tsinghua.edu.cn. 600 IN A     101.6.6.172
ntp.tsinghua.edu.cn.         600 IN CNAME alfa.s.tuna.tsinghua.edu.cn.
```

此外，还能发现 TTL 配置不合理（过长、过短均有），滥用 TXT 记录，未正确配置 SPF 记录等许多问题。这也体现出了域名管理者维护水平的不足。

#### 测试权威服务器的动态更新

RFC [TODO] 提出了 DNS 的动态更新，即客户端可以向权威 DNS 发送特定格式的请求，要求服务器更新（包括添加、修改、删除）其中的记录。与 AXFR 请求不同，不对动态更新请求进行严格的限制（包括内容校验和来源鉴权，包括 IP ACL 和 密钥认证），将会导致域名能被第三方任意修改，是极其危险的。我们同样对 `edu.cn` 中一级域名的各个权威服务器进行了测试，向他们发送动态更新请求。一般 Linux 下使用 nsupdate 工具完成，使用的命令格式为：

```nsupdate
> server ns1.foo.edu.cn
> update add nsupdate.foo.edu.cn 600 IN TXT "You have enabled anonymous nsupdate, which is extremely dangerous!"
> send
> quit
```

即简单地尝试添加一个名为 `nsupdate` 的二级域名，内容为提醒管理员的 TXT 记录。由于向公网开放无认证的 nsupdate 实在是过于愚蠢，我们并不对这个实验的结果抱任何希望，绝大部分服务器的返回结果也都是错误（包括SERVFAIL、NOTIMP、NOTAUTH），也有直接中断 TCP 连接的。但令我们感到十分震惊的是，有五个权威服务器**接受**了我们这一请求（添加后查询结果见 `nsupdate_check` 目录）！其中，`ns1.hdvtc.edu.cn` 服务器在其负责的 `hdvtc.edu.cn` 域上，同时接受 AXFR 请求和动态更新请求，可以说是门户敞开毫不设防。但也令人费解的是，正是这台服务器，使用动态更新添加记录后，查询的返回内容却是：

```bind
nsupdate.hdvtc.edu.cn.	600	IN	TXT	"You have enabled anonymous \005\000\000\000\000\000\000\000, which is extremely dangerous!"
```

其中我们添加的 `nsupdate` 字样被奇怪的串替代了。或许是管理员使用了某种 IDS 或防火墙，对请求中的 "nsupdate" 进行了某种形式的拦截或者替换，然后就以为万事大吉，不再关心。殊不知，这和用正则对 SQL 语句进行过滤一样，根本无法解决问题。

在实验完成后，我们使用 nsupdate 删除了添加的记录。

#### 通过AS4538宣告的前缀列表发现解析服务器

本实验的数据和代码在 `as4538_public_ns` 目录下。

在获得了 AS4538 所有的前缀后，我们试图发现其中所有对公众可用的解析服务器。为了简单起见，我们将“对公众可用”定义为：能正确回复对 `learn2018.tsinghua.edu.cn` 的 A 记录查询，即返回 IP 是 166.111.4.79。

由于 IP 数量较多（约 600 万个），我们没有自己编写脚本，而是借助 nmap 的多线程扫描功能进行测试。为了绕过 nmap 的主机扫描、端口扫描等比较费时的阶段，我们编写了 `test_dns_query.nse` 作为 nmap 的自定义脚本，并使用下列参数，借助 GNU Parallel 并行化地调用 nmap：

```bash
mkdir -p public_ns/
cat ../as4538_addresses/as4538_prefix4.txt | parallel -j 24 sudo nmap -T5 -n -Pn -sn --script=./test_dns_query.nse -oN public_ns/\`date +%s%N\` {}
```

即使有较小的超时（每次查询 250 毫秒），并禁用了重试，完整的扫描大约需要持续十个小时，一共进行了两次（见 `as4538_public_ns{1,2}`目录）。在对结果进行整理和合并后，我们得到了如下的结果：

AS 4538 中，至少有 57137 个 IP 地址能够向公众提供正确的 DNS 解析服务，有 35 个 IP 地址响应请求，但返回错误的结果；有 2058 个 IP 产生了请求错误。

对于返回正确结果的 IP（`as4538_public_ns.txt`），也有一些有趣的现象。其实零散的查询服务器并不多，如此巨大的数字主要来源于，有不少连续的地址块，比如整个 `/24`（如 `210.30.1.0/24`），都能返回结果，甚至包括了一些保留地址（比如.0与.255）。即便是处于负载均衡的考虑，也没有必要如此密集的部署解析服务器。这更可能是来源于一些特殊的配置（如整段 IP 未被实质性使用，而是指向同一台服务器，或一个负载均衡器）。

对于返回错误结果的 IP（`as4538_public_ns_wrong.txt`），它们绝大多数直接返回了自身 IP（公网或内网均有），应该是作为上网认证的 Captive Portal，捕获未认证用户的流量之用（直接向他们查询，返回的记录 TTL 大多数是 0，也能证明这一目的）。这些服务器显然不应当对公网开放，属于管理人员配置不当。但有两个 IP 对于任何查询都返回 `0.0.0.0`，用意实属不明。

对于产生请求错误的 IP（`as4538_public_ns_error.txt`），它们再次出现了聚类的情况。这些有可能是因为管理员想让服务器拒绝外部连接，但是用了激进的拒绝而不是丢弃策略；也有可能是 53 端口运行的根本不是 DNS 服务（比如，最常见的是利用计费网关的策略漏洞，在 53 端口搭建隧道即可绕过计费）而无法理解我们的请求。

需要说明的是，本题中的 IP 列表都不是精确的，同时也没有排除我们处于清华校园网以及 AS4538 内的可能带来的副作用。

### 中国大陆DNS劫持分析与绕过



## 结束语

从教育网DNS安全性测量一节可以看出，`edu.cn.`域名仍有一小部分存在安全隐患，此外，AS4538中有大量的公开解析服务器，若这些服务器不对请求的源地址加以限制（如限制为同一学校网络才能访问），则有可能被利用进行DDoS攻击。

在中国大陆DNS劫持分析与绕过一节，我们发现世界上相当多的著名网站的域名都在中国大陆遭到污染。从这一点就可以看出，中国大陆的互联网环境（包括政策上的以及部分技术上的）事实上是非常恶劣的，不过也正因为这个广泛部署的大型防火墙，很多相关研究能够开展，很多高质量学术论文得以发表。