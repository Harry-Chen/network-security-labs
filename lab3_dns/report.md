# 实验三：DNS安全性测量

- 2015011278 谭闻德：整理 AS4538 宣告的前缀列表、完成 `edu.cn.` 权威服务器的发现、统计单权威服务器的域名列表、探测被防火墙劫持的域名列表、撰写测试分析报告
- 2016010981 陈晟祺：完成 AS4538 解析服务器的发现与统计、测试权威服务器的区域传输、测试权威服务器的动态更新、撰写测试分析报告

## 概述

总体而言，本次实验分为以下几个部分：

- 教育网 DNS 安全性测量
  - 通过 `edu.cn.` 域名列表发现权威服务器
  - 统计单权威服务器的域名列表
  - 测试权威服务器的区域传输
  - 测试权威服务器的动态更新
  - 通过 AS4538 宣告的前缀列表发现解析服务器
- 中国大陆 DNS 劫持分析与绕过
  - 探测被防火墙劫持的域名列表
  - 开发用于绕过劫持的小工具

## 已有数据

由于 `edu.cn.` 的区域文件不公开，《实验指导手册》提供了 `edu.cn.` 域名列表。

其他数据均可以从公开渠道获得。

## 实验内容

### 教育网 DNS 安全性测量

本节实验主要在清华大学基础云平台的虚拟机上进行，该服务器接入清华大学校园网，运行 Debian 9 操作系统。

本节发现的所有潜在安全风险以及获得的其他数据，均已如数上报 CERNOC 与 CERT 进行处理。

#### 权威服务器的发现与统计

本小节使用《实验指导手册》提供的 `edu.cn.` 域名列表（`edu_cn_ns/edu_domain.txt`，含 6338 个域名），以及如下命令：

```bash
dig @dns2.edu.cn NS -f edu_domain.txt
```

该命令批量地查询指定域名列表的 NS 记录和相应的胶水记录（glue record， 即和 NS 记录关联的 A 或者 AAAA 记录）。`dig` 输出的原始数据保存在 `edu_cn_ns/edu_domain_ns_dig.txt`，滤去注释和空行之后的有用数据保存在 `edu_cn_ns/edu_domain_ns.txt`。本节还对每个域名的权威域名服务器列表，包括域名及对应 IPv4 地址，进行了进一步统计，结果存储在 `edu_cn_ns/ns_report_authority.txt`。注意到，有 14 个域名没有 NS 记录，约占 0.22%。

特别地，本节还统计了只有单一 NS 记录的域名列表（`edu_cn_ns/ns_report_single_authority.txt`），发现这样的域名有 337 个，在有 NS 记录的 6324 个域名中约占 5.33%。这些域名缺乏必要的冗余。

然而，经过对所有域名的 NS 记录进行简单分析后，本节还发现绝大部分域名的不同 NS 记录指向的该域名的权威服务器的 IP 地址十分邻近，有理由认为这些服务器在地理位置上也是邻近的。这表明，绝大部分域名的权威服务器并没有做到地理上的隔离。

#### 测试权威服务器的区域传输

区域传输（AXFR）是一种特殊的 DNS 请求类型，用于向权威服务器查询隶属于某个区域的所有记录，一般用于主从权威服务器之间的同步。由于其能泄露一些敏感信息（如内部使用而不希望被公开的域名等），同时，整个区域体积可能较大，一次区域传输对服务器压力较大，域名权威服务器一般不应公开开放区域传输功能。

本小节利用上一小节得到的所有域名及其对应的权威服务器列表，撰写 Python 3 脚本（`edu_cn_ns/try_axfr.py`）批量地向所有被发现的权威服务器发送对应域名的区域传输请求进行测试，每个请求使用的命令格式如下：

```bash
dig +time=1 +tries=1 @211.71.253.1 AXFR bjeea.edu.cn
```

其中，`time` 和 `tries` 参数是为了减少每一次请求的时间，避免服务器无响应或超时而拖慢测量。

令人惊讶的是，脚本从 68 台服务器上成功得到了返回结果，结果存储于 `edu_cn_ns/axfr_result` 目录中。其中，不同的域名共有 59 个，占有效域名的 0.93%。具体分析发现，有51个域名不只配置有一台权威服务器，其中46个配置有两台，5个配置有三台。一种合理的解释为，管理员或许是为了进行主从复制而打开了主域名服务器的区域传输功能，但是却没有正确配置访问权限控制。其他的8个域名仅有一台权威服务器，却也开启了区域传输功能，我们无法给出合理的解释。

另外，从获得的 DNS 区域文件中我们还能得到一些有趣的观察。比如，某些域名的区域文件中，许多（子）域名的 A 记录或 AAAA 记录指向同一个 IPv4 或 IPv6 地址（一个例子是 `hezeu.edu.cn`），容易看出同一台服务器事实上运行了多个服务。这种情况的最佳实践应当是使用 CNAME 记录来解耦服务器域名与服务域名对应的记录，如：

```bind
foo.example.com.    600 IN A      192.0.2.2
foo.example.com.    600 IN AAAA   2001:db8::22
bar.example.com.    600 IN A      192.0.2.3
bar.example.com.    600 IN AAAA   2001:db8::23
srv1.example.com.   600 IN CNAME  foo.example.com.
srv2.example.com.   600 IN CNAME  bar.example.com.
srv3.example.com.   600 IN CNAME  bar.example.com.
srv4.example.com.   600 IN CNAME  foo.example.com.
```

此外，我们还能发现 TTL 配置不合理（过长或过短）、滥用 TXT 记录或未正确配置 SPF 记录等问题。这都说明部分 `edu.cn.` 域名的配置需要进一步优化。

#### 测试权威服务器的动态更新

RFC 2136 提出了 DNS 的动态更新功能，允许客户端向权威服务器发送特定格式的请求，请求服务器更新（包括添加、修改或删除）其中的记录。与区域传输功能不同，若不对动态更新功能进行严格的限制（包括内容校验以及 IP ACL 或密钥认证等鉴权），将会允许未经授权的第三方任意修改域名解析记录，带来更大的安全威胁。本节同样编写脚本（`edu_cn_ns/try_nsupdate.py`）对 `edu.cn` 中域名的各个权威服务器进行了测试，向它们发送动态更新请求。在 Linux 下，动态更新请求可以利用 `nsupdate` 工具发送，使用的命令格式为：

```nsupdate
> server ns1.foo.edu.cn
> update add nsupdate.foo.edu.cn. 600 IN TXT "You have enabled anonymous nsupdate, which is extremely dangerous!"
> send
> quit
```

这组命令简单地尝试添加一个名为 `nsupdate` 的二级域名，包含一个 TXT 记录，记录内容为一个字符串。由于公开开放动态更新功能极其危险，以及出于对权威服务器维护人员的信任，我们起初并不对这个实验的结果抱任何希望。事实上，绝大部分服务器确实拒绝了脚本的请求，包括返回 SERVFAIL 、 NOTIMP 或 NOTAUTH 等错误代码，也有直接中断 TCP 连接的。但令人大跌眼镜的是，测试结果显示有五个权威服务器**接受并执行**了动态更新请求（添加后再次查询的结果请见 `edu_cn_ns/nsupdate_check` 目录）！其中，`hdvtc.edu.cn` 的权威服务器 `ns1.hdvtc.edu.cn` 同时接受区域传输请求和动态更新请求，门户敞开毫不设防。

在测试完成后，我们使用 `nsupdate` 删除了添加的记录。

#### 通过 AS4538 宣告的前缀列表发现解析服务器

本小节的数据和代码在 `as4538_public_ns` 目录下。

本节使用的 AS4538 宣告的前缀列表从 [Hurricane Electric](https://bgp.he.net/AS4538#_prefixes) 以及 [cidr-report](https://www.cidr-report.org/cgi-bin/as-report?as=AS4538&view=2.0) 获得，将它们合并以及删去重复宣告的子网后保存在 `as4538_addresses/as4538_prefix4.txt`，供后续步骤使用。需要说明的是，上述前缀列表可能与 AS4538 实际拥有的地址列表有所偏差。此外，本节实验在清华大学校园网和 AS4538 内完成，而这是一个更有利的测试环境，因为某些安全策略很可能仅在清华大学校园网或 AS4538 的边界部署。

在获得了 AS4538 所有的前缀后，我们试图发现其中所有对公众开放的解析服务器。其中，为了简单起见，若某个解析服务器能回复对 `learn2018.tsinghua.edu.cn` 的 A 记录查询，且返回 IP 地址是 `166.111.4.79`，那么认为这个解析服务器是对公众开放的。

由于 IP 地址数量很多（共 17315584 个），本节借助了 nmap 的多线程扫描功能进行测试。为了绕过 nmap 的主机发现和端口扫描等比较费时的阶段，我们编写了 `as4538_public_ns/test_dns_query.nse` 作为 nmap 的自定义脚本，并使用如下命令，借助 GNU Parallel 工具并行化地调用 nmap：

```bash
mkdir -p public_ns/
cat ../as4538_addresses/as4538_prefix4.txt | parallel -j 24 sudo nmap -T5 -n -Pn -sn --script=./test_dns_query.nse -oN public_ns/\`date +%s%N\` {}
```

即使选择较小的超时（每次查询 250 毫秒），且对于每个主机仅尝试一次，一次完整的扫描仍然需要大约十个小时。本节一共进行了两次测试，分别存储在 `as4538_public_ns/as4538_public_ns{1,2}` 目录中。在对结果进行整理和合并后，我们得到了如下的结果：

在 AS 4538 中，至少有 57137 个（约占全部 IP 地址的 0.33%） IP 地址能够向公众提供正确的 DNS 解析服务；另外，有 35 个 IP 地址响应请求，但返回错误的结果；还有 2058 个 IP 地址返回的数据报格式错误（可能不是 DNS 协议）。

对于返回正确结果的 IP 地址（`as4538_public_ns/as4538_public_ns.txt`），有一些有趣的现象。我们发现了解析服务器的局部性原理，与某个解析服务器相临近的 IP 地址很可能同样是解析服务器。IP 地址零散的解析服务器并不多，如此巨大的数字主要来自于不少连续的地址块，例如：

```
58.206.160.0  - 58.206.191.255    58.206.160.0/19
59.70.14.0    - 59.70.14.255      59.70.14.0/24
59.78.171.0   - 59.78.171.255     59.78.171.0/24
115.155.64.0  - 115.155.127.255   115.155.64.0/18
202.121.184.0 - 202.121.184.255   202.121.184.0/24
210.26.48.0   - 210.26.51.255     210.26.48.0/22
210.26.56.0   - 210.26.61.255     210.26.56.0/22, 210.26.60.0/23
210.26.112.0  - 210.26.115.255    210.26.112.0/22
210.26.117.0  - 210.26.127.255    210.26.117.0/24, 210.26.118.0/23, 210.26.120.0/21
210.30.0.0    - 210.30.15.255     210.30.0.0/20
210.36.120.0  - 210.36.127.255    210.36.120.0/21
210.42.72.0   - 210.42.79.255     210.42.72.0/21
211.70.76.0   - 211.70.79.255     211.70.76.0/22
218.197.32.0  - 218.197.47.255    218.197.32.0/20
219.217.176.0 - 219.217.191.255   219.217.176.0/20
219.246.32.0  - 219.246.35.255    219.246.32.0/22
219.246.44.0  - 219.246.44.255    219.246.44.0/24
219.246.48.0  - 219.246.81.255    219.246.48.0/20, 219.246.64.0/20, 219.246.80.0/23
219.246.88.0  - 219.246.90.255    219.246.88.0/23, 219.246.90.0/24
219.246.92.0  - 219.246.93.255    219.246.92.0/23
222.30.204.0  - 222.30.205.255    222.30.204.0/23
222.198.240.0 - 222.198.240.255   222.198.240.0/24
222.206.210.0 - 222.206.210.251   222.206.210.0/24
```

即便是出于负载均衡的考虑，也没有必要如此密集地部署解析服务器。事实上，通过返回结果的 TTL 值可以看出，对于每一个 IP 地址段，该 IP 地址段的所有结果似乎都来自于同一台或几台服务器。因此，这更可能是来源于一些特殊的配置，如整段 IP 地址未被实质性使用，而是指向同一台服务器或一个负载均衡器。

对于返回错误结果的 IP 地址（`as4538_public_ns/as4538_public_ns_wrong.txt`），它们绝大多数返回的是自身 IP 地址（公网或内网均有），应该是作为上网认证的 Captive Portal，捕获未认证用户的流量之用（直接向它们查询，返回的记录的 TTL 值大多数是 0，也能证明这一目的）。这些服务器显然不应当对公网开放，属于配置不当。此外，有趣的是，有两个 IP 对于任何查询都返回 `0.0.0.0`，用意不明。

对于产生请求错误的 IP 地址（`as4538_public_ns/as4538_public_ns_error.txt`），它们再次出现了聚类的情况（如 `202.207.104.0/21`）。这些有可能是因为管理员想让服务器拒绝外部连接，但是用了激进的拒绝而不是丢弃策略；也有可能是 53 端口运行的根本不是 DNS 服务（比如，最常见的是利用计费网关的策略漏洞，在 53 端口搭建隧道即可绕过计费）而无法理解我们的请求。

### 中国大陆 DNS 劫持分析与绕过

#### 探测被防火墙劫持的域名列表



#### 开发用于绕过劫持的小工具



## 结束语

从教育网 DNS 安全性测量一节可以看出，`edu.cn.` 域名仍有一小部分存在安全隐患和维护问题。此外，AS4538 中有大量的公开解析服务器，若这些服务器不对请求的源地址加以限制（如限制为同一学校网络才能访问），则有可能被利用进行 DDoS 攻击（一种常见的方法是伪造源地址向解析服务器发送 ANY 类型的请求，达到反射放大的效果）。

在中国大陆 DNS 劫持分析与绕过一节，我们发现世界上相当多的著名网站的域名都在中国大陆遭到污染。从这一点就可以看出，中国大陆的互联网环境（包括政策上的以及部分技术上的）事实上是非常恶劣的，不过也正因为这个广泛部署的大型防火墙，很多相关研究能够开展，很多高质量学术论文得以发表。
