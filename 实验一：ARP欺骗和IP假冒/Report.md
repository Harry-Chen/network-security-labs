# 实验一：ARP欺骗和IP假冒

2016010981 陈晟祺  
2015011278 谭闻德

## 问题1

### 问题环境

![configuration](q1/config.png)

三台机器连接在同一台交换机上，原本都应配置为 `192.168.26.0/24` 子网，但 B 的掩码错误配置为 `/27`。测试在此环境下各台机器之间的连通性，并解释原因。

注：本实验中，三台机器配置为：

| 名称    | MAC               | IP               | 网关           | 系统       |
| ------- | ----------------- | ---------------- | -------------- | ---------- |
| Gateway | 00:50:56:3a:80:9a | 192.168.2.2/24   | （上联互联网） | Ubuntu     |
| A       | 00:50:56:29:39:fa | 192.168.2.129/24 | 192.168.2.2    | Windows 10 |
| B       | 00:50:56:38:26:96 | 192.168.2.3/27   | 192.168.2.2    | Windows XP |

### 连通性测试：从网关

首先从网关 ping A 与 B，连通性都没有问题。这是由于网关与 A/B 分别都在同一广播域中，所以它们都能够直接与网关通信。此部分无需过多的解释。ARP与ICMP流量也是平凡的。

### 连通性测试：从 A

从 A 分别 ping 网关与 B，都能联通。如图：

![129_ping_from_129](q1/129_ping_from_129.jpg)

注意到，B 的回复 TTL 少了1，这说明回复经过了网关，而不是直接从 B 而来。从 A 上抓包，得到如下流量：

![129_ping_from_129_packet](q1/129_ping_from_129_packet.jpg)

上半部分是正常的与网关进行 ping，下半部分是 ping B。可以看到，从 A 的角度，除了 TTL 以外并没有任何异样。

在 B 上抓包，得到如下流量：

![129_ping_from_3](129_ping_from_3.jpg)

可以看到 B 按照配置，将回复包发送给了网关。网关发现这些包的出入 interface 是相同的（并无法意识到 B 的错误配置），向 B 发送了 `ICMP Redirect`，提醒 B 有到 A 更短的路径。

在网关上抓包，如图：

![129_ping_from_2](q1/129_ping_from_2.jpg)

可以看到 A 的请求包并没有经过网关，而 B 的回复包经过了网关。

### 连通性测试：从 B

从 B 分别 ping 网关与 A，都能联通。如图：

![3_ping_from_3](q1/3_ping_from_3.jpg)

观察回复的 TTL，可以看出网关与 A 都是直接从链路回复了 B。

在 A 上抓包，能看到从 B 发来的包 TTL - 1，的确是经过了网关，如下：

![3_ping_from_129](q1/3_ping_from_129.jpg)

在 B 上抓包，观察如下：

![3_ping_from_3_packet](q1/3_ping_from_3_packet.jpg)

这也是预期的：其与网关是直连的，而到 A 的 ICMP 包发送给了网关（截图中被选中包的目标 MAC 地址即为网关），而回复包直接由 A 从链路上发来。这里网关依旧给 B 发送了 `ICMP Redirect` 的提醒。

在网关上抓包，如图：

![3_ping_from_2](q1/3_ping_from_2.jpg)

可以看到 B 的请求包经过了网关，而 A 的回复包没有经过网关。

### 连通性测试：网关关闭

在网关关闭的情况下，A 与 B 之间互相均不能 ping 通，根本原因是 B 无法与 A 直接在链路上通信。

如 ping 是 A 发起的，在 B 上可以观察到 request 流量，但是 B 由于无法得到网关的 ARP 回应，所以无法发出回包，如图：

![129_ping_3_2_off_from_3](q1/129_ping_3_2_off_from_3.jpg)

如 ping 是 B 发起的，则 B 根本无法发出 ICMP 包，只是不停进行 ARP 询问，在 A 与 B 上都能抓到 B 询问网关 MAC 的 ARP 包，如图：

![3_ping_129_2_off_from_3](q1/3_ping_129_2_off_from_3.jpg)

### 说明与总结

本实验中的 ARP 流量都是正常的，即 A 和网关由于正确配置了掩码，它们都会对其余 IP 直接发送 ARP 询问以进行直接的链路通信。而 B 能回复它们的询问，但由于其认为自己与 A 并不在同一个广播域中，故其不会主动询问 A 的 MAC，而是选择询问网关 MAC 后交给网关处理。在网关正常工作的情况下，A 与 B 能够进行三层的通信，但不能进行二层的通信（因为B只能收到不能回复）。

## 问题2

### 实验环境

本实验在开放的 Tsinghua WiFi 环境下进行，计算机配置为：

| 名称   | MAC               | IP             | 系统              |
| ------ | ----------------- | -------------- | ----------------- |
| 受害者 | 9c:b6:d0:e3:ae:57 | 183.172.121.74 | Windows 10        |
| 攻击者 | a4:5e:60:f2:4e:57 | -              | macOS High Sierra |

受害者的网络环境如图：

![victim_net](q2/victim_net.png)

### 攻击：流量分析

攻击者在连接了同一个开放的 WiFi 后，启用无线网卡的监听模式抓包，就能立刻发现受害者的流量（本例中，受害者被观察到正从清华大学 TUNA 镜像站下载一个文件，因此有比较明显的流量特征）。如图：

![attacker_packet](q2/attacker_packet.png)

图中选中的数据包就是 AP 给受害者发送的一个 HTTPS 数据包。这实际上是一个 ISATAP 包（IPv6 in IPv4），因此能看到受害者的 IPv4 地址，同时在 802.11 帧内也能看到受害者的 MAC 地址（Receiver Address/Destination Address），另外还有网关地址（Source Address），以及 AP 的地址（Transmitter Address）。

事实上，通过监听模式就可以捕捉受害者与 AP 的所有流量，不需要伪装也能完成，这是由于开放的无线网络没有任何加密，因此是非常不安全的。

### 攻击：MAC 伪装

攻击者获得受害者 MAC 地址后，将自己的 MAC 改成受害者的并重新连接网络。由于清华大学的 WiFi 配置了 DHCP Spoofing，这里不设置静态 IP，而是使用 DHCP 来获得地址。

![attcker_proof](q2/attacker_proof.png)

如图，攻击者成功获得了相同的 IP，并且登录页面显示为受害者的。此时即使关闭监听模式，也能看到 AP 发送给受害者的流量。同时，由于 AP 和无线控制器事实上已经无法区分攻击者和受害者，受害者也不会观察到网络连接断开。

### 攻击：效果分析

在完成攻击后，攻击者即能够盗取受害者的身份，伪装成受害者与外界进行通信，正如上图中成功地访问了校园网认证页面。但是此途径并不是完美的，根本原因是此时两台设备都能收到很多不属于自己的包，而导致（尤其是TCP）连接状态错乱，不停产生重传与 RST 等现象，表现就是受害人的下载速度大幅下降甚至失败，ping 操作的延时页飘忽不定并经常失败。一些 IPv4 流量如下（都从受害者端捕捉，攻击者端也类似）：

![victim_packet](q2/victim_packet.png)

一些非正常流量。此图看似是 IPv6，实际上是 ISATAP 隧道，故还是 IPv4

![victim_packet_reset](q2/victim_packet_reset.png)

远端服务器因为无法理解流量（可能是攻击者的系统由于未识别的连接发起了 RST），中断了与受害人的正常通信。

对于 IPv6，即使两台机器因为 Privacy Extension 的原因具有不同的 Global Unicast（即 `2402:f000::/32`）地址，但是由于 IPv6 的 `Neighbour Dicovery` 与 DAD 机制，通信最后依旧对 Link Local 地址（即根据 MAC 生成的 `fe80::/16` 地址）有很强的依赖。所以在二者 MAC 相同的情况下，它们也无法正常地访问网络。

![victim_ipv6_dup_ack](q2/victim_ipv6_dup_ack.png)

可以看到此图中甚至对一个数据包进行了几乎十次 ACK 与重传。

### 攻击：加密情况

我们使用一个使用预共享密钥的 WPA 2 加密的 WiFi 网络也进行了类似的测试（假设攻击者能够连接到网络）。首先，我们无法再通过嗅探流量得到受害人的 IP（因为帧都是加密的）。而一旦攻击者以相同的 MAC 连接到网络，受害人与 AP 的通信就完全得不到回应；而受害人重连以后，攻击者也出现了类似的症状。如果我们使两者分别连接不同的 AP，在无线控制器上观察，攻击过程表现就像是一个客户端在两个 AP 间进行了一次漫游。这是由于，加密网络每次客户端 associate 到 AP 时，无线控制器都会与客户端协商一个新的会话密钥，因此前一个连接者自然无法再进行通信，后到者总是能够“抢占”网络。